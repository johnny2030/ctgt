<admintpl file="header" />
</head>
<body>
	<div class="wrap js-check-wrap">
		<ul class="nav nav-tabs">
			<li class="active"><a href="javascript:void(0);">{:L('SCORE_DETAILS')}</a></li>
		</ul>
		<form class="well form-search" method="post" id="cid-form" >
			<if condition="$entry eq 'search'">
				<select name="course_id" style="width: 200px;" >{$course_html}</select>
				<button class="btn btn-primary">{:L('SEARCH')}</button>
				<br>
				<br>
			</if>
			<span style="color:blue;"> {$student.full_name} </span>{:L('SCORE_DETAIL_HEAD')}  >>
		</form>
		<form class="js-ajax-form" method="post">
			<volist name="student_courses" id="student_course">
				<php>
					$score_requirement_ids = array();
					$score_requirements = D('Score')->field('distinct requirement_id')->where(array('student_id' => $student['id'],'course_id' => $student_course['course_id']))->select();
					foreach ( $score_requirements as $score_requirement) $score_requirement_ids[] = $score_requirement['requirement_id'];
					$score_requirement_ids_str = implode(',',$score_requirement_ids);
					
					$course = D('Course')->where(array('id' => $student_course['course_id']))->find();
					$course_scores = D('Score')->where(array('student_id' => $student['id'],'course_id' => $student_course['course_id']))->select();
					$course_requirements = D('CourseRequirement')->where(array('id' => array('in',$score_requirement_ids_str)))->select();
					
					$old_total_percent = 0;
					foreach ($course_requirements as $course_requirement) {
						$old_total_percent = $old_total_percent + $course_requirement['requirement_grade_percent'];
					}
					$ave_percent = 100/$old_total_percent;
					$real_score = 0;
					foreach ($course_requirements as $course_requirement) {
						$real_percent = $course_requirement['requirement_grade_percent']*$ave_percent;
						$requirement_scores = D('Score')->where(array('student_id' => $student['id'],'course_id' => $student_course['course_id'],'requirement_id' => $course_requirement['id']))->select();
						$total_score = 0;
						$index = 0;
						foreach ($requirement_scores as $requirement_score) {
							$total_score = $total_score + $requirement_score['test_score']*$requirement_score['points_system']-$requirement_score['deduct_marks'];
							$index++;
						}
						$real_score = $real_score + ($total_score/$index)*($real_percent/100);
					}
				</php>
				<notempty name="course_scores">
					<table class="table table-bordered">
						<tr>
							<th colspan="2">
								{:L('SCORE_COURSE_CODE')}:<span style="color:blue;"> {$course.course_code} </span> {:L('SCORE_COURSE_NAME')}:<span style="color:blue;"> {$course.course_name} </span> >> 
								{:L('SCORE_RATE')}: 
								<if condition="$real_score egt 92.50 AND $real_score elt 100">
									<span style="color:green;">A</span>
								</if>
								<if condition="$real_score egt 89.50 AND $real_score elt 92.49">
									<span style="color:green;">A-</span>
								</if>
								<if condition="$real_score egt 86.50 AND $real_score elt 89.49">
									<span style="color:green;">B+</span>
								</if>
								<if condition="$real_score egt 82.50 AND $real_score elt 86.49">
									<span style="color:green;">B</span>
								</if>
								<if condition="$real_score egt 79.50 AND $real_score elt 82.49">
									<span style="color:green;">B-</span>
								</if>
								<if condition="$real_score egt 76.50 AND $real_score elt 79.49">
									<span style="color:green;">C+</span>
								</if>
								<if condition="$real_score egt 69.50 AND $real_score elt 76.49">
									<span style="color:green;">C</span>
								</if>
								<if condition="$real_score egt 59.50 AND $real_score elt 69.49">
									<span style="color:red;">D</span>
								</if>
								<if condition="$real_score egt 0 AND $real_score elt 59.49">
									<span style="color:red;">F</span>
								</if>
							</th>
						</tr>
						<volist name="course_requirements" id="course_requirement">
							<php>
								$course_requirement_scores = D('Score')->where(array('student_id' => $student['id'],'course_id' => $student_course['course_id'],'requirement_id' => $course_requirement['id']))->select();
							</php>
							<notempty name="course_requirement_scores" >
								<tr>
									<th width="150">{$course_requirement.requirement_description}({:L('SCORE_PERCENT_OF_GRADE')} {$course_requirement.requirement_grade_percent}%)</th>
									<td>
										<table class="table table-hover table-bordered table-list">
											<thead>
												<tr>
													<th width="50">{:L('NO')}</th>
													<th width="100">{:L('SCORE_TEST_TIME')}</th>
													<th width="100">{:L('SCORE_POINTS_SYSTEM')}</th>
													<th width="100">{:L('SCORE_TEST_GRADE')}</th>
													<th width="100">{:L('SCORE_DEDUCT_MARKS')}</th>
													<th width="100">{:L('ACTIONS')}</th>
												</tr>
											</thead>
											<volist name="course_requirement_scores" id="course_requirement_score">
												<tr>
													<td>{$i}</td>
													<td>{$course_requirement_score.test_time}</td>
													<td>
														<if condition="$course_requirement_score.points_system eq 1">{:L('SCORE_HUNDRED_MARK_SYSTEM')}</if>
														<if condition="$course_requirement_score.points_system eq 10">{:L('SCORE_TEN_POINTS_SYSTEM')}</if>
													</td>
													<td><span style="color:red;">{$course_requirement_score.test_score}</span></td>
													<td><span style="color:red;">{$course_requirement_score.deduct_marks}</span></td>
													<td>
														<a href="{:U('score/edit',array('id'=>$course_requirement_score['id'],'course_id' => $course_id))}" class="btn btn-info btn-small">{:L('SCORE_MODIFY')}</a>
														<br />
													</td>
												</tr>
											</volist>
										</table>
									</td>
								</tr>
							</notempty>
						</volist>
					</table>
				</notempty>
			</volist>
		</form>
	</div>
	<script src="__PUBLIC__/js/common.js"></script>
	<script>
	setCookie('refersh_time', 0);
	function refersh_window() {
		var refersh_time = getCookie('refersh_time');
		if (refersh_time == 1) {
			window.location.reload();
		}
	}
	setInterval(function() {
		refersh_window()
	}, 2000);
	$(function() {
		$("#selected-cid").change(function() {
			$("#cid-form").submit();
		});
	});
	</script>
</body>
</html>