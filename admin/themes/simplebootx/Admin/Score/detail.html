<admintpl file="header" />
</head>
<body>
	<div class="wrap js-check-wrap">
		<form class="well form-search" method="post" id="cid-form" >
			<if condition="$entry eq 'search'">
				<select name="course_id" style="width: 200px;" >{$course_html}</select>
				<button class="btn btn-primary">{:L('SEARCH')}</button>
				<notempty name="course_id">
					<a href="javascript:open_iframe_dialog('{:U('score/enter',array('student_id'=>$student['id'],'course_id' => $course_id))}','{:L('SCORE_ENTER')}')" class="btn btn-warning">{:L('SCORE_ENTER')}</a>
				<else/>
					<button class="btn btn-warning" type="button" id="student_{$student.id}">{:L('SCORE_ENTER')}</button>
				</notempty>
				<br>
				<br>
			</if>
			<span style="color:blue;"> {$student.full_name} </span>{:L('SCORE_DETAIL_HEAD')}  >> 
			<notempty name="course_id">
				<a class="btn btn-success btn-small" href="{:U('score/export',array('course_id' => $course_id,'student_id' => $student['id']))}">{:L('EXPORT')}</a>
			</notempty>
		</form>
		<form class="js-ajax-form" method="post">
			<volist name="student_courses" id="course">
				<php>
					/* 某个学生某门课程的所有分数（包括无效分数） */
					$all_scores = D('Score')->where(array('course_id' => $course['id'],'student_id' => $student['id']))->order('test_date asc')->select();
					/* 修改后的最终平均成绩 */
					$final_scores = D('FinalScore')->where(array('course_id' => $course['id'],'student_id' => $student['id']))->find();
					$final_smeta = array();
					if($final_scores) $final_smeta = json_decode($final_scores['smeta'],true);
					/* 某个学生某门课程的所有有效分数 */
					$course_scores = D('Score')->where(array('course_id' => $course['id'],'student_id' => $student['id'],'score_status' => 1))->order('test_date asc')->select();
					/* 某门课程的requirement */
					$course_requirements = D('CourseRequirement')->where(array('course_id' => $course['id']))->select();
					/* 某个requirement的总分 */
					$total_scores = array();
					/* 整门课程的总分 */
					$real_score = 0;
					if($course_scores) {
						foreach ($course_requirements as $cr) {
							$requirement_description = $cr['requirement_description'];
							/* 初始化某个requirement的所有成绩的总分 */
							$total_scores[$requirement_description]['scores'] = 0;
							/* 初始化某个requirement的计算平均分次数 */
							$total_scores[$requirement_description]['counts'] = 0;
							/* 初始化某个requirement的计算平均分(average_score = scores/counts) */
							$total_scores[$requirement_description]['average_score'] = 0;
							/* 初始化签到FULL次数 */
							$total_scores[$requirement_description]['full_counts'] = 0;
							/* 初始化签到SICK次数 */
							$total_scores[$requirement_description]['sick_counts'] = 0;
							/* 初始化签到LATE小时数 */
							$total_scores[$requirement_description]['late_hours'] = 0;
							/* 初始化签到LATE出去整小时剩余的分钟数 */
							$total_scores[$requirement_description]['late_mins'] = 0;
							/* 初始化签到的总分数(late_scores = 10 - late_hours*0.5) */
							$total_scores[$requirement_description]['late_scores'] = 10;
							foreach ($course_scores as $cs) {
								$smeta = json_decode($cs['smeta'],true);
								/* 正常  */
								if ($cr['requirement_type'] == 1) {
									if ($smeta[$requirement_description] != "") {
										/* 常规（1倍计分）,期中/期末（2倍计分）  */
										$total_scores[$requirement_description]['scores'] += $smeta[$requirement_description]*$cs['test_type'];
										$total_scores[$requirement_description]['counts'] += $cs['test_type'];
									}
								}
								/* 签到  */
								if ($cr['requirement_type'] == 2) {
									/* FULL */
									if ($smeta[$requirement_description] == 1) {
										$total_scores[$requirement_description]['full_counts'] ++ ;
									}
									/* SICK */
									if ($smeta[$requirement_description] == 2) {
										$total_scores[$requirement_description]['sick_counts'] ++ ;
									}
									/* LATE */
									if ($smeta[$requirement_description] == 3) {
										/* 总共迟到的分钟数 */
										$total_scores[$requirement_description]['scores'] += $cs['test_late']; 
									}
								}
							}
							if ($cr['requirement_type'] == 1) {
								$total_scores[$requirement_description]['average_score'] = sprintf("%.2f", $total_scores[$requirement_description]['scores']/$total_scores[$requirement_description]['counts']);
								
								if ($final_smeta && $final_smeta[$requirement_description]['score'] != "") {
									$real_score += $final_smeta[$requirement_description]['score']*$cr['requirement_points_system']*$cr['requirement_grade_percent']/100;
								} else {
									$real_score += $total_scores[$requirement_description]['average_score']*$cr['requirement_points_system']*$cr['requirement_grade_percent']/100;
								}
							}
							if ($cr['requirement_type'] == 2) {
								/*总小时数，例如90分钟=1.5小时*/
								$total_scores[$requirement_description]['total_hours'] = sprintf("%.2f",$total_scores[$requirement_description]['scores']/60);
								/*整小时数，例如90分钟=1小时30分钟，取1小时*/
								$total_scores[$requirement_description]['late_hours'] = floor($total_scores[$requirement_description]['scores']/60);
								/*取余分钟数，例如90分钟=1小时30分钟，取30分钟*/
								$total_scores[$requirement_description]['late_mins'] = $total_scores[$requirement_description]['scores']%60;
								/*迟到扣分=总迟到分钟*0.01*/
								$total_scores[$requirement_description]['late_scores'] -= $total_scores[$requirement_description]['scores']*0.01;
								if ($final_smeta && $final_smeta[$requirement_description]['score'] != "") {
									$real_score += $final_smeta[$requirement_description]['score']*$cr['requirement_points_system']*$cr['requirement_grade_percent']/100;
								} else {
									$real_score += $total_scores[$requirement_description]['late_scores']*$cr['requirement_points_system']*$cr['requirement_grade_percent']/100;
								}
							}
						}
					}
					$real_score = sprintf("%.2f",$real_score);
				</php>
				<notempty name="all_scores">
					<table class="table table-bordered">
						<tr>
							<th colspan="2">
								{:L('SCORE_COURSE_CODE')}:<span style="color:blue;"> {$course.course_code} </span> {:L('SCORE_COURSE_NAME')}:<span style="color:blue;"> {$course.course_name} </span> >> 
								{:L('SCORE_FINAL_GRADES')}:<span style="color:red;"> {$real_score} </span>
								{:L('SCORE_RATE')}: 
								<if condition="$real_score egt 92.50 AND $real_score elt 100">
									<span style="color:green;">A</span>
								</if>
								<if condition="$real_score egt 89.50 AND $real_score elt 92.49">
									<span style="color:green;">A-</span>
								</if>
								<if condition="$real_score egt 86.50 AND $real_score elt 89.49">
									<span style="color:green;">B+</span>
								</if>
								<if condition="$real_score egt 82.50 AND $real_score elt 86.49">
									<span style="color:green;">B</span>
								</if>
								<if condition="$real_score egt 79.50 AND $real_score elt 82.49">
									<span style="color:green;">B-</span>
								</if>
								<if condition="$real_score egt 76.50 AND $real_score elt 79.49">
									<span style="color:green;">C+</span>
								</if>
								<if condition="$real_score egt 69.50 AND $real_score elt 76.49">
									<span style="color:green;">C</span>
								</if>
								<if condition="$real_score egt 59.50 AND $real_score elt 69.49">
									<span style="color:red;">D</span>
								</if>
								<if condition="$real_score egt 0 AND $real_score elt 59.49">
									<span style="color:red;">F</span>
								</if> 
							</th>
						</tr>
						<tr>
							<td>
								<div class="table-actions">
									<button class="btn btn-danger btn-small js-ajax-submit" type="submit" data-action="{:U('score/toggle',array('hide'=>1))}" data-subcheck="true">{:L('SCORE_SET_TO_INVALID')}</button>
									<button class="btn btn-success btn-small js-ajax-submit" type="submit" data-action="{:U('score/toggle',array('display'=>1))}" data-subcheck="true">{:L('SCORE_SET_TO_VALID')}</button>
								</div>
								<table class="table table-hover table-bordered table-list">
									<thead>
										<tr>
											<th width="16"><label><input type="checkbox" class="js-check-all" data-direction="x" data-checklist="js-check-x"></label></th>
											<th width="25">{:L('STATUS')}</th>
											<th width="50">{:L('NO')}</th>
											<th width="100">{:L('SCORE_TEST_DATE')}</th>
											<volist name="course_requirements" id="cr">
												<th width="100">{$cr.requirement_description}({$cr.requirement_grade_percent}%)</th>
											</volist>
										</tr>
									</thead>
									<php>$index = 0;</php>
									<volist name="all_scores" id="as">
										<php>$index++;</php>
										<tr>
											<td><input type="checkbox" class="js-check" data-yid="js-check-y" data-xid="js-check-x" name="ids[]" value="{$as.id}"></td>
											<td>
												<notempty name="as.score_status">
													<a data-toggle="tooltip" title="{:L('SCORE_VALID')}"><i class="fa fa-check"></i></a>
												<else/>
													<a data-toggle="tooltip" title="{:L('SCORE_INVALID')}"><i class="fa fa-close"></i></a>
												</notempty>
											</td>
											<td>{$index}</td>
											<td>{$as.test_date}</td>
											<php>$smeta = json_decode($as['smeta'],true);</php>
											<volist name="course_requirements" id="cr">
												<php>
													$requirement_description = $cr['requirement_description'];
													$score_val = $smeta[$requirement_description];
												</php>
												<if condition="$cr.requirement_type eq 1">
													<td>{$score_val}</td>
												</if>
												<if condition="$cr.requirement_type eq 2">
													<td>
														<if condition="$score_val eq 1">Full</if>
														<if condition="$score_val eq 2"><span style="color:red;">Sick Leave</span></if>
														<if condition="$score_val eq 3">Late {$as.test_late} min</if>
													</td>
												</if>
											</volist>
										</tr>
									</volist>
									<tr>
										<php>
										</php>
										<th width="150" colspan="4">
											{:L('SCORE_AVERAGE')}
											<a class="btn btn-success btn-small js-ajax-delete" href="{:U('score/final_delete',array('course_id' => $course['id'],'student_id' => $student['id']))}" data-msg="{:L('是否确定按照成绩算法计算平均成绩？')}">{:L('SCORE_NORMAL')}</a>
										</th>
										<volist name="course_requirements" id="cr">
											<php>$requirement_description = $cr['requirement_description'];</php>
											<if condition="$cr.requirement_type eq 1">
												<th width="100" id="th_{$i}_{$student.id}_{$course.id}">
													<php>if($final_smeta && $final_smeta[$requirement_description]['score'] != ""){</php>
														<span style="color:red;" title="Operator: {$final_smeta.$requirement_description.operator}&#10;Original Score: {$final_smeta.$requirement_description.original_score}&#10;Time: {$final_smeta.$requirement_description.time}">
															{$final_smeta.$requirement_description.score}
														</span>
													<php>}else{</php>
														<span style="color:red;">{$total_scores.$requirement_description.average_score}</span>
													<php>}</php>
													<div class="hide">
														<if condition="$cr.requirement_points_system eq 1">
															<input style="width:70px;height:10px;" type="text" name="smeta[$requirement_description][score]" id="input_{$i}_{$student.id}_{$course.id}" onblur= "if( /^\d*(\.\d{1,2})?$/.test(this.value)){if(this.value>100||this.value<0){alert('只能输入小于等于100的非负数，小数点后最多保留两位');this.value='';}}else{alert('只能输入小于等于100的非负数，小数点后最多保留两位');this.value='';}">
														</if>
														<if condition="$cr.requirement_points_system eq 10">
															<input style="width:70px;height:10px;" type="text" name="smeta[$requirement_description][score]" id="input_{$i}_{$student.id}_{$course.id}" onblur= "if( /^\d*(\.\d{1,2})?$/.test(this.value)){if(this.value>10||this.value<0){alert('只能输入小于等于10的非负数，小数点后最多保留两位');this.value='';}}else{alert('只能输入小于等于10的非负数，小数点后最多保留两位');this.value='';}">
														</if>
														<br><a id="submit_{$i}_{$student.id}_{$course.id}" class="btn btn-success btn-small">✔</a>
														<a id="cancel_{$i}_{$student.id}_{$course.id}" class="btn btn-danger btn-small">✘</a>
													</div>
												</th>
											</if>
											<if condition="$cr.requirement_type eq 2">
												<th width="100" id="th_{$i}_{$student.id}_{$course.id}">
													<php>if($final_smeta && $final_smeta[$requirement_description]['score'] != ""){</php>
														<span style="color:red;" title="Full: {$total_scores.$requirement_description.full_counts} times&#10;Sick Leave: {$total_scores.$requirement_description.sick_counts} times&#10;Lay Time: {$total_scores.$requirement_description.total_hours} h &#10;--------------------&#10;Operator: {$final_smeta.$requirement_description.operator}&#10;Original Score: {$final_smeta.$requirement_description.original_score}&#10;Time: {$final_smeta.$requirement_description.time}">
															{$final_smeta.$requirement_description.score}
														</span>
													<php>}else{</php>
														<span style="color:red;" title="Full: {$total_scores.$requirement_description.full_counts} times&#10;Sick Leave: {$total_scores.$requirement_description.sick_counts} times&#10;Lay Time: {$total_scores.$requirement_description.total_hours} h ">{$total_scores.$requirement_description.late_scores}</span><br>
													<php>}</php>
													<div class="hide">
														<if condition="$cr.requirement_points_system eq 1">
															<input style="width:70px;height:10px;" type="text" name="smeta[$requirement_description][score]" id="input_{$i}_{$student.id}_{$course.id}" onblur= "if( /^\d*(\.\d{1,2})?$/.test(this.value)){if(this.value>100||this.value<0){alert('只能输入小于等于100的非负数，小数点后最多保留两位');this.value='';}}else{alert('只能输入小于等于100的非负数，小数点后最多保留两位');this.value='';}">
														</if>
														<if condition="$cr.requirement_points_system eq 10">
															<input style="width:70px;height:10px;" type="text" name="smeta[$requirement_description][score]" id="input_{$i}_{$student.id}_{$course.id}" onblur= "if( /^\d*(\.\d{1,2})?$/.test(this.value)){if(this.value>10||this.value<0){alert('只能输入小于等于10的非负数，小数点后最多保留两位');this.value='';}}else{alert('只能输入小于等于10的非负数，小数点后最多保留两位');this.value='';}">
														</if>
														<br><a id="submit_{$i}_{$student.id}_{$course.id}" class="btn btn-success btn-small">✔</a>
														<a id="cancel_{$i}_{$student.id}_{$course.id}" class="btn btn-danger btn-small">✘</a>
													</div>
												</th>
											</if>
											<script>
												//使用jquery绑定td的双击dblclick
												$('#th_{$i}_{$student.id}_{$course.id}').dblclick(function(){
													$('#th_{$i}_{$student.id}_{$course.id} span').addClass('hide');
													$('#th_{$i}_{$student.id}_{$course.id} div').removeClass('hide');
												});
												//点击提交/取消
												$('#submit_{$i}_{$student.id}_{$course.id}').click(function(){
													//原始值
													var original_value = $('#th_{$i}_{$student.id}_{$course.id} span').text();
													//字段的名字
													var param_key = '{$requirement_description}';
													//字段的值
													var param_value = $('#input_{$i}_{$student.id}_{$course.id}').val();
													$.post('{:U("score/final_async_edit")}', {original_value: original_value,param_key: param_key,param_value: param_value,course_id:{$course.id},student_id:{$student.id}}, function(data){
														//alert(data);
														var str = data.substring(1);
														$('#th_{$i}_{$student.id}_{$course.id} span').html(str);
														$('#th_{$i}_{$student.id}_{$course.id} span').removeClass('hide');
														$('#th_{$i}_{$student.id}_{$course.id} div').addClass('hide');
													});
												});
												$('#cancel_{$i}_{$student.id}_{$course.id}').click(function(){
													$('#th_{$i}_{$student.id}_{$course.id} div').addClass('hide');
													$('#th_{$i}_{$student.id}_{$course.id} span').removeClass('hide');
												});
											</script>
										</volist>
									</tr>
								</table>
							</td>
						</tr>
					</table>
				</notempty>
			</volist>
		</form>
	</div>
	<script src="__PUBLIC__/js/common.js"></script>
	<script>
		setCookie('refersh_time', 0);
		function refersh_window() {
			var refersh_time = getCookie('refersh_time');
			if (refersh_time == 1) {
				window.location.reload();
			}
		}
		setInterval(function() {
			refersh_window()
		}, 2000);
		$(function() {
			$("td").each(function(){
				if($(this).text() != "" && $(this).text() == 0) $(this).css('color','red');
			});
			$("#selected-cid").change(function() {
				$("#cid-form").submit();
			});
			Wind.use('ajaxForm', 'artDialog', 'iframeTools', function() {
				//选择课程
				$('#student_{$student.id}').click(function(e) {
					var student_id = {$student.id};
					
					art.dialog.open("__ROOT__/index.php?g=admin&m=student&a=select_course&id="+ student_id , {
						title : "选择课程",
						width : "300px"
					});
				});
			});
			
		});
	</script>
</body>
</html>